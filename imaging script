#!/usr/bin/env python3
import sys
import struct
import os

def make_bmp_exact_size(path, target_size=400, width=10, height=10):
    # 24-bit BMP row math
    row_unpadded = 3 * width
    row_padded = ((row_unpadded + 3) // 4) * 4
    pixel_array_size = row_padded * height

    file_header_size = 14
    dib_header_size = 40
    minimal_size = file_header_size + dib_header_size + pixel_array_size

    if target_size < minimal_size:
        raise ValueError(
            f"Target size {target_size} too small for {width}x{height}. "
            f"Minimum is {minimal_size} bytes."
        )

    filler_size = target_size - minimal_size
    bfOffBits = file_header_size + dib_header_size + filler_size

    # BMP File Header
    file_header = (
        b"BM" +
        struct.pack("<IHHI", target_size, 0, 0, bfOffBits)
    )

    # DIB header (BITMAPINFOHEADER)
    dib_header = struct.pack(
        "<IIIHHIIIIII",
        dib_header_size,
        width,
        height,
        1,
        24,
        0,
        pixel_array_size,
        2835,
        2835,
        0,
        0
    )

    filler = b"\x00" * filler_size

    # Build pixel rows (Blue, Green, Red)
    pixel_row = b""
    for _ in range(width):
        pixel_row += bytes([0x30, 0xD0, 0x50])  # green-ish
    pad_len = row_padded - row_unpadded
    pixel_row += b"\x00" * pad_len

    pixel_data = pixel_row * height

    with open(path, "wb") as f:
        f.write(file_header)
        f.write(dib_header)
        f.write(filler)
        f.write(pixel_data)

    print(f"Created {path} ({target_size} bytes)")

if __name__ == "__main__":
    # Run 10 times automatically
    out_dir = "/mnt/data/bmp10x10_out"
    os.makedirs(out_dir, exist_ok=True)

    for i in range(10):
        filename = f"img10x10_{i+1}.bmp"
        path = os.path.join(out_dir, filename)
        make_bmp_exact_size(path, 400, 10, 10)

    print(f"10 images written to {out_dir}")
